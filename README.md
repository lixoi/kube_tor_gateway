# VPN шлюз с множественной инкапсуляцией (аналог TOR-сети)

Цель данного решения - продемонстрировать нестандартное использование системы управления контейнерами на базе Kubernetes, 
так как k8s (по мнению явторов) - это SDK :)

# Начальные условия 

Для реализации луковичной маршрутизации (построение VPN цепочки с произвольным количеством узлов) необходимо использовать CNI Multus (для задания маршрутов на L3 уровне) + базовый плагин с поддержкой NP (для сетевой изоляции шлюзов на уровне NS), например Calico

Предполагается использовать протоколы OnenVPN и Wireguard в любом сочетании.

# Функциональность

Развертывание производится через helm chart (папка helm).
В templates задаются сетевые интерфейсы через NetworkAttachmentDefinition и параметры узлов цепочки через CRD. Параметры подключения хранятся в secrets (Vault) и монтируются как файл в файловой системе ПОДа.

Если какой-либо из узлов цепочти не может подключиться к серверу, то оператор берет из Vault новые параметры подключение и перезапускает узел.

Так как для контейнеров необходимы привилегии NET_ADMIN, docker-образы собраны через nixpkgs docker build (папки ovpn-build-image и wguard-build-image) с минимальным окружением. Данный подход позволяет минимизировать вектор атаки через VPN-клиента. 
Использование distroless-образов приводит к необходимости запускать kube-оператором sidecar-контейнеры (busybox) c health check для отслеживания состояния работы ПОДа (узла цепочки).

VPN-клиенты логируют сообщения в stdout.

# Этапы работ: 

На первом этапе проводились тестовыеы испытания, была развернута цепочка client1-client2-client3-server3-server2-server1 через docker-compose (в проекте не представлено).
На втором была поднята K8s через kubeadm (папка K8s). Облачные провайдеры не подходят из-за CNI Multus.
На третем разработан helm chart (папка helm) развертования цепочки, состоящей из 3-х OpenVPN узлов.

На текущем этапе идет разработка kube-оператора (ветка feature проекта) для рализации логики поддержания vpn-цепочки в рабочем состоянии (см. Функциональность).
На завершающем - интеграция с ELK и Vault.

# P.S.
К назначенной дате не все сделано, так как: 
1. исследовался механизм запуска wireguard в usermode-режиме  (без прав на создание виртуального интерфейса).
2. не ясно было как изменять состояние ПОДа при наличии ошибок в работе VPN-приложения.
